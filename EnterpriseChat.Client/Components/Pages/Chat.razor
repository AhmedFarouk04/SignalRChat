@page "/chat/{RoomId:guid}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using EnterpriseChat.Client.ViewModels
@using EnterpriseChat.Client.Models
@using Microsoft.JSInterop
@inject ChatViewModel VM
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IDisposable
@inject RoomsViewModel RoomsVM

<div class="chat-page">

    <TopBar Room="@VM.Room"
            MembersCount="@(VM.GroupMembers?.Members.Count ?? 0)"
            OnlineCount="@VM.OnlineUsers.Count"
            OtherUser="@VM.OtherUser"
            IsMuted="@VM.IsMuted"
            IsBlocked="@VM.IsBlocked"
            OnMuteToggle="ToggleMute"
            OnBlock="BlockOtherUser"
            OnUnblock="UnblockOtherUser"
            OnMembers="OpenMembers" />


    @if (VM.UiError != null)
    {
        <div class="chat-error">@VM.UiError</div>
    }
    else if (VM.Room == null)
    {
        <div class="chat-error">This room no longer exists.</div>
    }
    else if (VM.IsRemoved)
    {
        <div class="chat-error">
            You were removed from this group.
            <button class="mini-btn" @onclick="@(() => Nav.NavigateTo("/rooms"))">Back to rooms</button>
        </div>
    }

    else
    {
        <div class="chat-body">

            @if (VM.Room.Type == "Group")
            {
                <PresenceBar OnlineUsers="@VM.OnlineUsers" />
            }

            @if (VM.IsDisconnected)
            {
                <div class="connection-banner">Reconnecting…</div>
            }

            <div class="chat-messages">
                <MessageList Messages="@VM.Messages"
                             CurrentUserId="@VM.CurrentUserId"
                             Room="@VM.Room"
                             GroupMembers="@(VM.GroupMembers?.Members ?? new())"
                             OnRetry="RetrySend"
                             OnReachedBottom="HandleReachedBottom"
                             AutoScroll="true" />


                <TypingIndicator TypingUsers="@VM.TypingUsers" />
            </div>

            <div class="chat-actions-row">
                <button type="button" class="mini-btn" @onclick="OpenAttachments">📎 Attachments</button>

                @if (VM.Room?.Type == "Group")
                {
                    <button type="button" class="mini-btn"
                            @onclick="@(() => Nav.NavigateTo($"/groups/{RoomId}/settings"))">
                        ⚙️ Group settings
                    </button>
                }
            </div>

            @if (_attachmentsOpen)
            {
                <div class="drawer-backdrop" @onclick="CloseAttachments"></div>

                <aside class="drawer" role="dialog" aria-modal="true" aria-label="Attachments drawer" tabindex="0">
                    <div class="drawer-header">
                        <div>
                            <div class="drawer-name">Attachments</div>
                            <div class="drawer-sub">Room files</div>
                        </div>

                        <button class="icon-btn" title="Close" @onclick="CloseAttachments" autofocus>✕</button>
                    </div>

                    <div class="drawer-list">
                        <ChatAttachments RoomId="RoomId" />
                    </div>
                </aside>
            }

            <div class="chat-input">
                @if (VM.IsOtherDeleted)
                {
                    <div class="blocked-banner">This user is no longer available.</div>
                }
                else if (VM.IsBlocked)
                {
                    <div class="blocked-banner">You blocked this user. Unblock to send messages.</div>
                }
                else
                {
                    <ChatInput OnSend="Send"
                               OnUserTyping="NotifyTyping" />
                }
            </div>

            @if (_membersOpen && VM.Room?.Type == "Group")
            {
                <MembersDrawer IsOpen="_membersOpen"
                               Members="@VM.GetAllMembersForDrawer()"
                               OwnerId="@(VM.GroupMembers?.OwnerId ?? Guid.Empty)"
                               CanManageMembers="@(VM.GroupMembers?.OwnerId == VM.CurrentUserId)"
                               OnRemove="RemoveMember"
                               OnClose="CloseMembers" />
            }
        </div>
    }
</div>

@code {
    [Parameter] public Guid RoomId { get; set; }

    private bool _membersOpen;
    private DotNetObjectReference<ChatPageInterop>? _objRef;
    private bool _escapeRegistered;
    private bool _attachmentsOpen;
    private bool _renderQueued;

    private void OpenAttachments() => _attachmentsOpen = true;
    private void CloseAttachments() => _attachmentsOpen = false;

    private CancellationTokenSource? _readCts;
    private Guid _lastSentReadId = Guid.Empty;

    private IJSObjectReference? _chatModule;

    protected override async Task OnInitializedAsync()
    {
        VM.Changed += OnVmChanged;
        await VM.InitializeAsync(RoomId);

        if (VM.Room == null && VM.UiError == null)
            Nav.NavigateTo("/rooms");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_escapeRegistered)
        {
            _objRef = DotNetObjectReference.Create(new ChatPageInterop(this));

            _chatModule = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./js/chatPage.js");

            await _chatModule.InvokeVoidAsync("registerEscape", _objRef);
            await JS.InvokeVoidAsync("scrollToBottom", "chat-messages");
            _escapeRegistered = true;
        }
    }

    public void Dispose()
    {
        VM.Changed -= OnVmChanged;

        _readCts?.Cancel();
        _readCts?.Dispose();

        _ = Task.Run(async () =>
        {
            try { await VM.DisposeAsync(); } catch { }
        });

        _ = Task.Run(async () =>
        {
            try
            {
                if (_chatModule != null)
                    await _chatModule.InvokeVoidAsync("unregisterEscape");

                if (_chatModule != null)
                    await _chatModule.DisposeAsync();
            }
            catch { }
        });

        _objRef?.Dispose();
    }

    private Task Send(string text)
    {
        Console.WriteLine($"[Chat.razor] Send fired: '{text}'");
        return VM.SendAsync(RoomId, text);
    }
    private Task RetrySend(MessageModel msg) => VM.SendAsync(RoomId, msg.Content);
    private Task NotifyTyping() => VM.NotifyTypingAsync(RoomId);

    private Task HandleReachedBottom(Guid lastMessageId)
    {
        if (lastMessageId == Guid.Empty) return Task.CompletedTask;
        if (lastMessageId == _lastSentReadId) return Task.CompletedTask;

        _readCts?.Cancel();
        _readCts?.Dispose();
        _readCts = new CancellationTokenSource();
        var ct = _readCts.Token;

        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(400, ct);
                if (ct.IsCancellationRequested) return;

                _lastSentReadId = lastMessageId;

                // ✅ نبلغ السيرفر
                await VM.MarkRoomReadAsync(RoomId, lastMessageId);

                // ✅ نصفر badge فورًا بدون refresh
                await InvokeAsync(() => RoomsVM.MarkRoomAsReadLocal(RoomId, lastMessageId));
            }
            catch { }
        }, ct);

        return Task.CompletedTask;
    }


    private Task RemoveMember(Guid userId) => VM.RemoveMemberAsync(RoomId, userId);

    private Task BlockOtherUser()
        => VM.OtherUser == null
            ? Task.CompletedTask
            : VM.BlockUserAsync(VM.OtherUser.Id);

    private Task ToggleMute() => VM.ToggleMuteAsync(RoomId);

    private void OpenMembers()
    {
        if (VM.Room?.Type == "Group") _membersOpen = true;
    }

    private void CloseMembers() => _membersOpen = false;


    private async void OnVmChanged()
    {
        if (_renderQueued) return;
        _renderQueued = true;

        _ = InvokeAsync(async () =>
        {
            try
            {
                await Task.Delay(50); // throttling قديم – خليه

                StateHasChanged();

                // ✅ scroll to bottom كل update (load أو new message)
                await JS.InvokeVoidAsync("scrollToBottom", "chat-messages");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Scroll error: {ex.Message}");
            }
            finally
            {
                _renderQueued = false;
            }
        });
    }

    private sealed class ChatPageInterop
    {
        private readonly Chat _page;
        public ChatPageInterop(Chat page) => _page = page;

        [JSInvokable]
        public Task OnGlobalEscape()
        {
            var changed = false;

            if (_page._attachmentsOpen)
            {
                _page.CloseAttachments();
                changed = true;
            }

            if (_page._membersOpen)
            {
                _page.CloseMembers();
                changed = true;
            }

            return changed ? _page.InvokeAsync(_page.StateHasChanged) : Task.CompletedTask;
        }
    }

    private Task UnblockOtherUser()
    => VM.OtherUser == null
        ? Task.CompletedTask
        : VM.UnblockUserAsync(VM.OtherUser.Id);

}