@page "/chat/{RoomId:guid}"

@using EnterpriseChat.Client.ViewModels
@using EnterpriseChat.Client.Models
@inject ChatViewModel VM
@inject NavigationManager Nav

@implements IDisposable

<AuthGuard>
<TopBar Room="@VM.Room"
        MembersCount="@VM.OnlineUsers.Count"
        OtherUser="@VM.OtherUser"
        IsMuted="@VM.IsMuted"
        OnMuteToggle="ToggleMute"
        OnBlock="BlockOtherUser" />

@if (VM.UiError != null)
{
    <div class="chat-error">
        @VM.UiError
    </div>
}
else if (VM.Room == null)
{
    <div class="chat-error">
        This room no longer exists.
    </div>
}
else if (VM.IsRemoved)
{
    <div class="chat-error">
        You were removed from this group.
    </div>
}
else
{
    @* Group members *@
    @if (VM.Room.Type == "Group" && VM.GroupMembers != null)
    {
        <GroupMembersPanel
            OwnerId="@VM.GroupMembers.OwnerId"
            Members="@VM.GroupMembers.Members"
            CurrentUserId="@VM.CurrentUserId"
            OnRemove="RemoveMember"
            OnLeave="LeaveGroup" />
    }

    @* Presence *@
    @if (VM.Room.Type != "Private")
    {
        <PresenceBar OnlineUsers="@VM.OnlineUsers" />
    }

    @* Connection banner *@
    @if (VM.IsDisconnected)
    {
        <div class="connection-banner">
            Reconnecting…
        </div>
    }

    @* Messages *@
    <MessageList Messages="@VM.Messages"
                 CurrentUserId="@VM.CurrentUserId"
                 OnRetry="RetrySend"
                 OnReachedBottom="HandleReachedBottom" />

    <TypingIndicator TypingUsers="@VM.TypingUsers" />

    @* Block / Deleted handling *@
    @if (VM.IsOtherDeleted)
    {
        <div class="blocked-banner">
            This user is no longer available.
        </div>
    }
    else if (VM.IsBlocked)
    {
        <div class="blocked-banner">
            You blocked this user. Unblock to send messages.
        </div>
    }
    else
    {
        <ChatInput OnSend="Send"
                   OnUserTyping="NotifyTyping" />
    }
}
   </AuthGuard>
@code {
    [Parameter] public Guid RoomId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await VM.InitializeAsync(RoomId);

        if (VM.Room == null && VM.UiError == null)
            Nav.NavigateTo("/rooms");
    }

    private Task Send(string text)
        => VM.SendAsync(RoomId, text);

    private Task RetrySend(MessageModel msg)
        => VM.SendAsync(RoomId, msg.Content);

    private Task NotifyTyping()
        => VM.NotifyTypingAsync(RoomId);

    private Task HandleReachedBottom(Guid lastMessageId)
        => lastMessageId == Guid.Empty
            ? Task.CompletedTask
            : VM.MarkRoomReadAsync(RoomId, lastMessageId);

    private Task RemoveMember(Guid userId)
        => VM.RemoveMemberAsync(RoomId, userId);

    private Task LeaveGroup()
    {
        Nav.NavigateTo("/rooms");
        return Task.CompletedTask;
    }

    private Task BlockOtherUser()
        => VM.OtherUser == null
            ? Task.CompletedTask
            : VM.BlockUserAsync(VM.OtherUser.Id);

    private Task ToggleMute()
        => VM.ToggleMuteAsync(RoomId);

    public void Dispose()
    {
        _ = VM.DisposeAsync();
    }
}
