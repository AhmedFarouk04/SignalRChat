@page "/chat/{RoomId:guid}"

@using EnterpriseChat.Client.Models
@inject ApiClient Api
@inject ChatHubClient Hub
@inject CurrentUserContext CurrentUser
@inject NavigationManager Nav


<TopBar Room="@room"
        MembersCount="@onlineUsers.Count"
        OtherUser="@otherUser"
        IsMuted="@isMuted"
        OnMuteToggle="ToggleMute"
        OnBlock="BlockOtherUser" />

@if (room == null)
{
    <div class="chat-error">
        This room no longer exists.
    </div>
}
else
{
    @* ===== Removed from group ===== *@
    @if (isRemoved)
    {
        <div class="chat-error">
            You were removed from this group.
        </div>
    }
    else
    {
        @* ===== Group members ===== *@
        @if (room.Type == "Group" && groupMembers != null)
        {
            <GroupMembersPanel
                OwnerId="@groupMembers.OwnerId"
                Members="@groupMembers.Members"
                CurrentUserId="@currentUserId"
                OnRemove="RemoveMember"
                OnLeave="LeaveGroup" />
        }

        @* ===== Presence ===== *@
        @if (room.Type != "Private")
        {
            <PresenceBar OnlineUsers="@onlineUsers" />
        }

        @* ===== Connection banner ===== *@
        @if (isDisconnected)
        {
            <div class="connection-banner">
                Reconnecting…
            </div>
        }

        @* ===== Messages ===== *@
        <MessageList Messages="@messages"
                     CurrentUserId="@currentUserId"
                     OnRetry="RetrySend"
                     OnReachedBottom="HandleReachedBottom" />

        <TypingIndicator TypingUsers="@typingUsers" />

        @* ===== Block / Deleted handling ===== *@
        @if (isOtherDeleted)
        {
            <div class="blocked-banner">
                This user is no longer available.
            </div>
        }
        else if (isBlocked)
        {
            <div class="blocked-banner">
                You blocked this user. Unblock to send messages.
            </div>
        }
        else
        {
            <ChatInput OnSend="Send"
                       OnUserTyping="NotifyTyping" />
        }
    }
}

@code {
    [Parameter] public Guid RoomId { get; set; }

    private RoomModel? room;
    private List<MessageModel> messages = new();
    private List<UserModel> onlineUsers = new();
    private List<UserModel> typingUsers = new();
    private UserModel? otherUser;
    private GroupMembersModel? groupMembers;

    private Guid currentUserId;

    private bool isMuted;
    private bool isBlocked;
    private bool isDisconnected;
    private bool isOtherDeleted;
    private bool isRemoved;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUserId = await CurrentUser.GetUserIdAsync()
                ?? throw new InvalidOperationException("User not authenticated");

            room = await Api.GetRoomAsync(RoomId);

            if (room == null)
            {
                Nav.NavigateTo("/rooms");
                return;
            }

            messages = (await Api.GetMessagesAsync(RoomId)).ToList();
        }
        catch
        {
            Nav.NavigateTo("/rooms");
            return;
        }

        // ===== Group members =====
        if (room.Type == "Group")
        {
            var dto = await Api.GetGroupMembersAsync(RoomId);

            groupMembers = new GroupMembersModel
            {
                OwnerId = dto.OwnerId,
                Members = dto.Members
                    .Select(m => new UserModel
                    {
                        Id = m.Id,
                        DisplayName = m.DisplayName
                    })
                    .ToList()
            };
        }

        // ===== Private chat =====
        if (room.Type == "Private")
        {
            if (room.OtherUserId == null)
            {
                isOtherDeleted = true;
            }
            else
            {
                otherUser = new UserModel
                {
                    Id = room.OtherUserId.Value,
                    DisplayName = room.OtherDisplayName!,
                    IsOnline = false
                };
            }
        }

        RegisterHubEvents();

        await Hub.ConnectAsync();
        await Hub.JoinRoomAsync(RoomId);
    }

    private void RegisterHubEvents()
    {
        Hub.MessageReceived += OnMessageReceived;
        Hub.RoomPresenceUpdated += OnRoomPresenceUpdated;
        Hub.TypingStarted += OnTypingStarted;
        Hub.TypingStopped += OnTypingStopped;
        Hub.MessageDelivered += OnMessageDelivered;

        Hub.MessageRead += id =>
        {
            if (!messages.Any(m => m.Id == id))
                return;

            var msg = messages.First(m => m.Id == id);
            if (msg.Status != MessageStatus.Read)
            {
                msg.Status = MessageStatus.Read;
                InvokeAsync(StateHasChanged);
            }
        };

        Hub.UserOnline += userId =>
        {
            if (otherUser?.Id == userId)
            {
                otherUser.IsOnline = true;
                otherUser.LastSeen = null;
                InvokeAsync(StateHasChanged);
            }
        };

        Hub.UserOffline += userId =>
        {
            if (otherUser?.Id == userId)
            {
                otherUser.IsOnline = false;
                otherUser.LastSeen = DateTime.UtcNow;
                InvokeAsync(StateHasChanged);
            }
        };

        Hub.PresenceSnapshot += users =>
        {
            if (otherUser == null) return;

            otherUser.IsOnline = users.Contains(otherUser.Id);
            if (!otherUser.IsOnline)
                otherUser.LastSeen ??= DateTime.UtcNow;

            InvokeAsync(StateHasChanged);
        };

        Hub.Disconnected += () =>
        {
            isDisconnected = true;
            InvokeAsync(StateHasChanged);
        };

        Hub.Reconnected += () =>
        {
            isDisconnected = false;
            InvokeAsync(StateHasChanged);
        };

        Hub.RemovedFromRoom += roomId =>
        {
            if (roomId == RoomId)
            {
                isRemoved = true;
                InvokeAsync(StateHasChanged);

                Task.Delay(1500).ContinueWith(_ =>
                    Nav.NavigateTo("/rooms"));
            }
        };
    }

    // ===== Presence =====
    private async void OnRoomPresenceUpdated(Guid roomId, int _)
    {
        if (roomId != RoomId)
            return;

        var users = await Api.GetOnlineUsersInRoomAsync(RoomId);

        onlineUsers = users
            .Where(u => u.Id != currentUserId)
            .Select(u => new UserModel
            {
                Id = u.Id,
                DisplayName = u.DisplayName,
                IsOnline = true
            })
            .ToList();

        await InvokeAsync(StateHasChanged);
    }

    // ===== Typing =====
    private void OnTypingStarted(Guid roomId, Guid userId)
    {
        if (isBlocked || isOtherDeleted)
            return;

        if (roomId != RoomId || userId == currentUserId)
            return;

        if (typingUsers.Any(u => u.Id == userId))
            return;

        var user = onlineUsers.FirstOrDefault(u => u.Id == userId);
        if (user != null)
        {
            typingUsers.Add(user);
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnTypingStopped(Guid roomId, Guid userId)
    {
        typingUsers.RemoveAll(u => u.Id == userId);
        InvokeAsync(StateHasChanged);
    }

    // ===== Messages =====
    private void OnMessageReceived(MessageModel message)
    {
        if (message.RoomId != RoomId)
            return;

        var existing = messages.FirstOrDefault(m =>
            m.Status == MessageStatus.Pending &&
            m.Content == message.Content &&
            m.SenderId == message.SenderId);

        if (existing != null)
        {
            existing.Id = message.Id;
            existing.Status = MessageStatus.Sent;
            existing.Error = null;
        }
        else
        {
            messages.Add(message);
        }

        InvokeAsync(StateHasChanged);
    }

    private async Task Send(string text)
    {
        if (isBlocked || isOtherDeleted)
            return;

        if (string.IsNullOrWhiteSpace(text))
            return;

        var pending = new MessageModel
        {
            Id = Guid.Empty,
            RoomId = RoomId,
            SenderId = currentUserId,
            Content = text,
            CreatedAt = DateTime.UtcNow,
            Status = MessageStatus.Pending
        };

        messages.Add(pending);
        await InvokeAsync(StateHasChanged);

        try
        {
            var dto = await Api.SendMessageAsync(RoomId, text);
            pending.Id = dto.Id;
            pending.Status = MessageStatus.Sent;
        }
        catch
        {
            pending.Status = MessageStatus.Failed;
            pending.Error = "Failed to send";
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task RetrySend(MessageModel msg)
    {
        msg.Status = MessageStatus.Pending;
        msg.Error = null;

        try
        {
            var dto = await Api.SendMessageAsync(RoomId, msg.Content);
            msg.Id = dto.Id;
            msg.Status = MessageStatus.Sent;
        }
        catch
        {
            msg.Status = MessageStatus.Failed;
            msg.Error = "Failed to send";
        }

        await InvokeAsync(StateHasChanged);
    }

    private Task NotifyTyping()
        => Hub.NotifyTypingAsync(RoomId);

    private Task HandleReachedBottom(Guid lastMessageId)
        => lastMessageId == Guid.Empty
            ? Task.CompletedTask
            : Hub.MarkRoomReadAsync(RoomId, lastMessageId);

    private void OnMessageDelivered(Guid messageId)
    {
        var msg = messages.FirstOrDefault(m => m.Id == messageId);
        if (msg?.Status == MessageStatus.Sent)
        {
            msg.Status = MessageStatus.Delivered;
            InvokeAsync(StateHasChanged);
        }
    }

    // ===== Group actions =====
    private async Task RemoveMember(Guid userId)
    {
        await Api.RemoveMemberAsync(RoomId, userId);
        groupMembers?.Members.RemoveAll(u => u.Id == userId);
        await InvokeAsync(StateHasChanged);
    }

    private async Task LeaveGroup()
    {
        await Api.RemoveMemberAsync(RoomId, currentUserId);
        Nav.NavigateTo("/rooms");
    }

    // ===== Block / Mute =====
    private async Task BlockOtherUser()
    {
        if (otherUser == null)
            return;

        await Api.BlockUserAsync(otherUser.Id);
        isBlocked = true;
        typingUsers.Clear();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleMute()
    {
        if (!isMuted)
            await Api.MuteRoomAsync(RoomId);
        else
            await Api.UnmuteRoomAsync(RoomId);

        isMuted = !isMuted;
        await InvokeAsync(StateHasChanged);
    }
}
