@using EnterpriseChat.Client.Models
@using EnterpriseChat.Client.ViewModels
@using EnterpriseChat.Client.Services.Realtime
@using EnterpriseChat.Client.Authentication.Abstractions
@inject IChatRealtimeClient Realtime
@inject ICurrentUser CurrentUser
@implements IDisposable

<div class="topbar">
    @if (VM?.IsSearching == true)
    {
        <div class="search-mode">
            <button class="icon-btn" @onclick="() => VM.IsSearching = false">⬅️</button>
            <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="Search in chat..."
                       @bind="VM.SearchQuery" @bind:event="oninput" autofocus />
                @if (VM.SearchResults.Any())
                {
                    <div class="search-results-dropdown">
                        @foreach (var res in VM.SearchResults)
                        {
                            <div class="search-item" @onclick="() => OnSearchResultClick(res.Id)">
                                <div class="search-item-text">@res.Content</div>
                                <div class="search-item-meta">@res.CreatedAt.ToLocalTime().ToString("MMM dd, h:mm tt")</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        @if (Room is null)
        {
            <div class="room-header">
                <span class="room-title">Loading…</span>
            </div>
        }
        else
        {
            <div class="room-header">
                <div class="room-main">
                    <div class="room-title">@Title</div>
                    <div class="room-sub">
                        @if (IsPrivate && OtherUser != null)
                        {
                            @if (VM.IsBlockedByMe || VM.IsBlockedMe)
                            {
                                <span class="dot offline"></span>
                                <span>Offline</span>
                            }
                            else if (OtherUser.IsOnline)
                            {
                                <span class="dot online"></span>
                                <span>Online</span>
                            }
                            else if (OtherUser.LastSeen != null)
                            {
                                var lastSeen = OtherUser.LastSeen.Value.ToLocalTime();
                                var today = DateTime.Today;
                                var yesterday = today.AddDays(-1);
                                string lastSeenText;
                                if (lastSeen.Date == today)
                                    lastSeenText = $"Today at {lastSeen:t}";
                                else if (lastSeen.Date == yesterday)
                                    lastSeenText = $"Yesterday at {lastSeen:t}";
                                else
                                    lastSeenText = lastSeen.ToString("MMM dd, yyyy 'at' h:mm tt");
                                <span class="dot offline"></span>
                                <span>Last seen @lastSeenText</span>
                            }
                            else
                            {
                                <span class="dot offline"></span>
                                <span>Offline</span>
                            }
                        }
                        else
                        {
                            <span>@MembersCount members</span>
                            <span>•</span>
                            <span>@(CurrentOnlineCount) online</span>
                        }
                    </div>
                </div>
                <div class="room-actions">
                    <button class="icon-btn" title="Search" @onclick="() => VM.IsSearching = true">🔍</button>
                    @if (!IsPrivate)
                    {
                        <button class="icon-btn" type="button" title="Members" @onclick="() => OnMembers.InvokeAsync()">
                            👥
                        </button>
                    }
                    @if (IsPrivate)
                    {
                        <button class="icon-btn" type="button" title="@(IsBlockedByMe ? "Unblock" : "Block")" @onclick="() => (IsBlockedByMe ? OnUnblock : OnBlock).InvokeAsync()">
                            @(IsBlockedByMe ? "🔓" : "🚫")
                        </button>
                    }
                    <button class="icon-btn" type="button" title="Mute" @onclick="() => OnMuteToggle.InvokeAsync()">
                        @(IsMuted ? "🔕" : "🔔")
                    </button>
                </div>
            </div>
            @if (VM?.PinnedMessages != null && VM.PinnedMessages.Any())
            {
                var currentPinned = GetCurrentPinned();
                <div class="pinned-msg-bar" @onclick="RotatePinnedMessages">
                    <div class="pin-indicator-group">
                        <span class="pin-icon-small">📌</span>
                        @if (VM.PinnedMessages.Count > 1)
                        {
                            <span class="pin-count-text">@VM.PinnedMessages.Count</span>
                        }
                    </div>
                    <div class="pin-preview-text">
                        <span style="color: var(--accent-main); font-weight: bold;">Pinned: </span>
                        @currentPinned.Content
                    </div>
                    <button class="icon-btn" style="font-size: 10px;" @onclick:stopPropagation="true"
                            @onclick="() => OnScrollToMessage.InvokeAsync(currentPinned.Id)">
                        ➡️
                    </button>
                </div>
            }
        }
    }
</div>

@code {
    [Parameter] public RoomModel? Room { get; set; }
    [Parameter] public ChatViewModel? VM { get; set; }
    [Parameter] public EventCallback<Guid> OnScrollToMessage { get; set; }
    [Parameter] public int MembersCount { get; set; }
    [Parameter] public int OnlineCount { get; set; }
    [Parameter] public UserModel? OtherUser { get; set; }
    [Parameter] public bool IsMuted { get; set; }
    [Parameter] public EventCallback OnMuteToggle { get; set; }
    [Parameter] public EventCallback OnBlock { get; set; }
    [Parameter] public EventCallback OnMembers { get; set; }
    [Parameter] public bool IsBlockedByMe { get; set; }
    [Parameter] public EventCallback OnUnblock { get; set; }

    private bool IsPrivate => Room?.Type == "Private";
    private string Title => IsPrivate ? Room?.OtherDisplayName ?? "Private Chat" : Room?.Name ?? "Group";
    private int _displayIndex = 0;
    private Guid _currentUserId;
    private int CurrentOnlineCount => VM?.OnlineUsers?.Count ?? OnlineCount;

    protected override async Task OnInitializedAsync()
    {
        var userId = await CurrentUser.GetUserIdAsync();
        _currentUserId = userId ?? Guid.Empty;
        Realtime.UserBlockedByMeChanged += OnBlockedByMe;
        Realtime.UserBlockedMeChanged += OnBlockedMe;
        Realtime.UserOnline += OnUserOnline;
        Realtime.UserOffline += OnUserOffline;
        Realtime.UserLastSeenUpdated += OnUserLastSeenUpdated;
        Realtime.RoomPresenceUpdated += OnRoomPresenceUpdated;

        if (VM != null)
        {
            VM.Changed += OnViewModelChanged;
        }
    }
    private void OnBlockedByMe(Guid userId, bool blocked)
    {
        if (OtherUser?.Id == userId)
        {
            if (blocked)
            {
                OtherUser.IsOnline = false;
                OtherUser.LastSeen = null;
            }
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnBlockedMe(Guid userId, bool blocked)
    {
        if (OtherUser?.Id == userId)
        {
            if (blocked)
            {
                OtherUser.IsOnline = false;
                OtherUser.LastSeen = null;
            }
            InvokeAsync(StateHasChanged);
        }
    }
    private void OnUserOnline(Guid userId)
    {
        if (OtherUser?.Id == userId)
        {
            OtherUser.IsOnline = true;
            OtherUser.LastSeen = null;
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserOffline(Guid userId)
    {
        if (OtherUser?.Id == userId)
        {
            OtherUser.IsOnline = false;
            OtherUser.LastSeen = DateTime.UtcNow;
        }
        InvokeAsync(StateHasChanged);

    }

    private void OnUserLastSeenUpdated(Guid userId, DateTime lastSeen)
    {
        if (OtherUser?.Id == userId)
        {
            OtherUser.IsOnline = false;
            OtherUser.LastSeen = lastSeen;
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnRoomPresenceUpdated(Guid roomId, int count)
    {
        if (Room?.Id == roomId && !IsPrivate)
        {
            OnlineCount = count; // تحديث القيمة
            InvokeAsync(StateHasChanged); // إعادة الرسم
            Console.WriteLine($"[TopBar] Updated online count for room {roomId}: {count}");
        }
    }

    private MessageModel GetCurrentPinned()
    {
        if (VM?.PinnedMessages == null || !VM.PinnedMessages.Any())
            return null;
        if (_displayIndex >= VM.PinnedMessages.Count) _displayIndex = 0;
        return VM.PinnedMessages[_displayIndex];
    }

    private void RotatePinnedMessages()
    {
        if (VM?.PinnedMessages == null || !VM.PinnedMessages.Any()) return;
        if (VM.PinnedMessages.Count <= 1)
        {
            OnScrollToMessage.InvokeAsync(VM.PinnedMessages[0].Id);
            return;
        }
        _displayIndex++;
        if (_displayIndex >= VM.PinnedMessages.Count) _displayIndex = 0;
        StateHasChanged();
    }

    private async Task OnSearchResultClick(Guid messageId)
    {
        if (VM != null)
        {
            VM.IsSearching = false;
            await Task.Delay(100);
            await OnScrollToMessage.InvokeAsync(messageId);
        }
    }
    private void OnViewModelChanged()
    {
        InvokeAsync(StateHasChanged);
        Console.WriteLine($"[TopBar] ViewModel changed, online count: {VM?.OnlineUsers?.Count ?? 0}");
    }
    public void Dispose()
    {
        Realtime.UserOnline -= OnUserOnline;
        Realtime.UserOffline -= OnUserOffline;
        Realtime.UserLastSeenUpdated -= OnUserLastSeenUpdated;
        Realtime.RoomPresenceUpdated -= OnRoomPresenceUpdated;
        Realtime.UserBlockedByMeChanged -= OnBlockedByMe;
        Realtime.UserBlockedMeChanged -= OnBlockedMe;
        if (VM != null)
        {
            VM.Changed -= OnViewModelChanged;
        }
    }
}