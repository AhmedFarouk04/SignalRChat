@using EnterpriseChat.Client.Models
@using EnterpriseChat.Client.ViewModels

<div class="topbar">
    @if (VM?.IsSearching == true)
    {
        <div class="search-mode">
            <button class="icon-btn" @onclick="() => VM.IsSearching = false">⬅️</button>
            <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="Search in chat..."
                       @bind="VM.SearchQuery" @bind:event="oninput" autofocus />

                @if (VM.SearchResults.Any())
                {
                    <div class="search-results-dropdown">
                        @foreach (var res in VM.SearchResults)
                        {
                            <div class="search-item" @onclick="() => OnSearchResultClick(res.Id)">
                                <div class="search-item-text">@res.Content</div>
                                <div class="search-item-meta">@res.CreatedAt.ToLocalTime().ToString("MMM dd, h:mm tt")</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        @if (Room is null)
        {
            <div class="room-header">
                <span class="room-title">Loading…</span>
            </div>
        }
        else
        {
            <div class="room-header">
                <div class="room-main">
                    <div class="room-title">@Title</div>

                    <div class="room-sub">
                        @if (IsPrivate && OtherUser != null)
                        {
                            @if (OtherUser.IsOnline)
                            {
                                <span class="dot online"></span>
                                <span>Online</span>
                            }
                            else if (OtherUser.LastSeen != null)
                            {
                                <span>Last seen @OtherUser.LastSeen.Value.ToLocalTime().ToShortTimeString()</span>
                            }
                            else
                            {
                                <span>Offline</span>
                            }
                        }
                        else
                        {
                            <span>@MembersCount members</span>
                            <span>•</span>
                            <span>@OnlineCount online</span>
                        }
                    </div>
                </div>

                <div class="room-actions">
                    <!-- زر البحث الجديد -->
                    <button class="icon-btn" title="Search" @onclick="() => VM.IsSearching = true">🔍</button>

                    @if (!IsPrivate)
                    {
                        <button class="icon-btn" type="button" title="Members" @onclick="() => OnMembers.InvokeAsync()">
                            👥
                        </button>
                    }

                    @if (IsPrivate)
                    {
                        <button class="icon-btn" type="button" title="@(IsBlocked ? "Unblock" : "Block")" @onclick="() => (IsBlocked ? OnUnblock : OnBlock).InvokeAsync()">
                            @(IsBlocked ? "🔓" : "🚫")
                        </button>
                    }

                    <button class="icon-btn" type="button" title="Mute" @onclick="() => OnMuteToggle.InvokeAsync()">
                        @(IsMuted ? "🔕" : "🔔")
                    </button>
                </div>
            </div>

            @if (VM?.PinnedMessages != null && VM.PinnedMessages.Any())
            {
                // الحصول على الرسالة المراد عرضها بناءً على الـ Index الحالي
                var currentPinned = GetCurrentPinned();

                <div class="pinned-msg-bar" @onclick="RotatePinnedMessages">
                    <div class="pin-indicator-group">
                        <span class="pin-icon-small">📌</span>
                        @if (VM.PinnedMessages.Count > 1)
                        {
                            <span class="pin-count-text">@VM.PinnedMessages.Count</span>
                        }
                    </div>
                    <div class="pin-preview-text">
                        <span style="color: var(--accent-main); font-weight: bold;">Pinned: </span>
                        @currentPinned.Content
                    </div>

                    @* زر صغير اختياري للذهاب للرسالة الأصلية *@
                    <button class="icon-btn" style="font-size: 10px;" @onclick:stopPropagation="true"
                            @onclick="() => OnScrollToMessage.InvokeAsync(currentPinned.Id)">
                        ➡️
                    </button>
                </div>
            }
        }
    }
</div>

@code {
    [Parameter] public RoomModel? Room { get; set; }
    [Parameter] public ChatViewModel? VM { get; set; }
    [Parameter] public EventCallback<Guid> OnScrollToMessage { get; set; }

    [Parameter] public int MembersCount { get; set; }
    [Parameter] public int OnlineCount { get; set; }
    [Parameter] public UserModel? OtherUser { get; set; }
    [Parameter] public bool IsMuted { get; set; }
    [Parameter] public EventCallback OnMuteToggle { get; set; }
    [Parameter] public EventCallback OnBlock { get; set; }
    [Parameter] public EventCallback OnMembers { get; set; }
    [Parameter] public bool IsBlocked { get; set; }
    [Parameter] public EventCallback OnUnblock { get; set; }

    private bool IsPrivate => Room?.Type == "Private";
    private string Title => IsPrivate ? Room?.OtherDisplayName ?? "Private Chat" : Room?.Name ?? "Group";

    private int _displayIndex = 0;

    private MessageModel GetCurrentPinned()
    {
        // حماية لو الـ index خرج عن النطاق
        if (_displayIndex >= VM.PinnedMessages.Count) _displayIndex = 0;
        return VM.PinnedMessages[_displayIndex];
    }

    private void RotatePinnedMessages()
    {
        if (VM.PinnedMessages.Count <= 1)
        {
            // لو واحدة بس، اضغط يوديك ليها علطول
            OnScrollToMessage.InvokeAsync(VM.PinnedMessages[0].Id);
            return;
        }

        // لو أكتر من واحدة، يقلب الـ Index
        _displayIndex++;
        if (_displayIndex >= VM.PinnedMessages.Count)
        {
            _displayIndex = 0;
        }
        StateHasChanged();
    }

    private async Task OnSearchResultClick(Guid messageId)
    {
        // 1. نقفل وضع البحث
        VM.IsSearching = false;

        // 2. نستنى لحظة عشان الـ UI يستقر ويبطل يحاول ينزل تحت
        await Task.Delay(100);

        // 3. نطلع للرسالة
        await OnScrollToMessage.InvokeAsync(messageId);
    }
}