@using EnterpriseChat.Client.Components.Reaction
@using EnterpriseChat.Client.Models
@using EnterpriseChat.Client.ViewModels
@using EnterpriseChat.Domain.Enums
@using ClientMessageStatus = EnterpriseChat.Client.Models.MessageStatus
@using Microsoft.JSInterop
@inject ChatViewModel VM
@implements IAsyncDisposable
@inject IJSRuntime JS

@if (Message is null)
{
    <div class="system-message-container">
        <div class="system-content">[Message is null]</div>
    </div>
}
else
{
    var systemType = GetSystemMessageType();
    var isSystem = !string.IsNullOrEmpty(systemType);
    var compactMeta = (Message.Content?.Trim().Length ?? 0) <= 6;

    @if (isSystem)
    {
        <div class="system-message-container" id="@($"message-{Message.Id}")" @key="@($"sys-{Message.Id}")">
            <div class="system-message @systemType">
                <div class="system-content">
                    <span class="system-text">@GetSystemMessageText()</span>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="msg-selection-wrapper @(IsMine ? "mine-wrapper" : "theirs-wrapper") @(VM.IsSelectionMode ? "selection-active" : "")"
             @key="@($"msg-{Message.Id}")"
             @onclick="() => { if (VM.IsSelectionMode) VM.ToggleMessageSelection(Message.Id); }">

            @if (VM.IsSelectionMode && !Message.IsDeleted)
            {
                <div class="custom-checkbox @(VM.SelectedMessageIds.Contains(Message.Id) ? "selected" : "")">
                    @if (VM.SelectedMessageIds.Contains(Message.Id))
                    {
                        <span class="check-mark">✓</span>
                    }
                </div>
            }

            <div class="msg @(IsMine ? "mine" : "theirs") @GroupPosClass @(IsNew ? "new" : "") @(IsMenuOpen ? "menu-active" : "") @(IsReactionOpen ? "reactions-open" : "")"
                 id="@($"message-{Message.Id}")">

                @if (!Message.IsDeleted)
                {
                    <button class="quick-react-btn"
                            type="button"
                            @onclick:stopPropagation="true"
                            @onclick="() => OnToggleReaction.InvokeAsync(Message!.Id)">
                        🙂
                    </button>
                }

                <div class="msg-body @(compactMeta ? "compact-meta" : "") @(Message.IsDeleted ? "deleted" : "")">

                    @if (!Message.IsDeleted)
                    {
                        <button class="msg-options-btn" type="button" @onclick:stopPropagation="true" @onclick="ToggleMenu">
                            <svg viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M3.3 4.6L9 10.3l5.7-5.7 1.6 1.6L9 13.5 1.7 6.2l1.6-1.6z"></path></svg>
                        </button>
                    }

                    @if (IsMenuOpen)
                    {
                        <div class="msg-context-menu" @onclick:stopPropagation="true">
                            <button class="menu-item" @onclick="async () => { CloseMenu(); await OnReplyClick(); }">Reply</button>
                            @if (IsMine && !Message.IsDeleted)
                            {
                                <button class="menu-item" @onclick="() => { CloseMenu(); OnEditRequested.InvokeAsync(Message); }">Edit</button>
                            }
                            <button class="menu-item delete" @onclick="HandleDeleteClick">Delete</button>

                            @if (!Message.IsDeleted)
                            {
                                <button class="menu-item" @onclick="() => { CloseMenu(); VM.OpenPinModal(Message.Id); }">
                                    @(VM.IsMessagePinned(Message.Id) ? "Unpin" : "Pin")
                                </button>
                                <button class="menu-item" @onclick="() => { CloseMenu(); VM.IsSelectionMode = true; VM.ToggleMessageSelection(Message.Id); }">
                                    Forward
                                </button>
                            }
                        </div>
                    }

                    @if (Message.ReplyInfo != null && !Message.IsDeleted)
                    {
                        <div class="reply-preview" @onclick="OnReplyPreviewClick">
                            <div class="reply-header">
                                <span class="reply-sender">@(Message.ReplyInfo.SenderId == CurrentUserId ? "You" : Message.ReplyInfo.SenderName)</span>
                            </div>
                            <div class="reply-content">
                                @(Message.ReplyInfo.IsDeleted ? "This message was deleted" : Message.ReplyInfo.ContentPreview)
                            </div>
                        </div>
                    }

                    <div class="msg-text" dir="auto">
                        @if (Message.IsDeleted)
                        {
                            <em class="deleted-message">🚫 This message was deleted</em>
                        }
                        else
                        {
                            <MarkdownText Content="@Message.Content" />
                            @if (Message.IsEdited)
                            {
                                <span class="edited-badge">(edited)</span>
                            }
                        }
                    </div>

                    <div class="message-meta" dir="ltr">
                        <span class="message-time">@Message.CreatedAt.ToLocalTime().ToString("h:mm tt")</span>
                        @if (IsMine)
                        {
                            <span class="message-status-icon @GetStatusClass()">
                                @switch (Message.PersonalStatus)
                                {
                                    case ClientMessageStatus.Pending:
                                        <span class="st">⌛</span>
                                        break;
                                    case ClientMessageStatus.Sent:
                                        <span class="st">✓</span>
                                        break;
                                    case ClientMessageStatus.Delivered:
                                        <span class="st">✓✓</span>
                                        break;
                                    case ClientMessageStatus.Read:
                                        <span class="st" style="color: #38bdf8;">✓✓</span>
                                        break;
                                    case ClientMessageStatus.Failed:
                                        <span class="st">!</span>
                                        break;
                                    default:
                                        <span class="st">?</span>
                                        break;
                                }
                            </span>
                        }
                    </div>
                </div>

                @if (IsReactionOpen)
                {
                    <div class="reactions-hover-wrap">
                        <ReactionsPanel MessageId="@Message.Id" Reactions="@Message.Reactions" OnReaction="HandleReaction" />
                    </div>
                }

                @if (Message?.Reactions?.Counts?.Any() == true)
                {
                    <div class="msg-reaction-chip" @onclick:stopPropagation="true" @onclick="OpenReactionDetails">
                        <div class="reaction-chip-content">
                            @foreach (var r in Message.Reactions.Counts.Keys.Take(3))
                            {
                                <span class="reaction-emoji">@GetReactionEmoji(r)</span>
                            }
                            <span class="reaction-count">@Message.Reactions.Counts.Values.Sum()</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
}

@code {
    [Parameter] public MessageModel? Message { get; set; }
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public List<UserModel> GroupMembers { get; set; } = new();
    [Parameter] public string GroupPosition { get; set; } = "single";
    [Parameter] public bool IsNew { get; set; }
    [Parameter] public bool ShowMeta { get; set; } = true;
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }
    [Parameter] public EventCallback<ReactionPayload> OnReaction { get; set; }
    [Parameter] public EventCallback<Guid> OnReplyRequested { get; set; }
    [Parameter] public EventCallback<Guid> OnScrollToMessage { get; set; }
    [Parameter] public EventCallback<Guid> OnOpenReactionDetails { get; set; }
    [Parameter] public Guid? OpenReactionMessageId { get; set; }
    [Parameter] public EventCallback<Guid> OnToggleReaction { get; set; }
    [Parameter] public EventCallback<MessageModel> OnEditRequested { get; set; }
    [Parameter] public EventCallback<MessageModel> OnDeleteRequested { get; set; }

    private DotNetObjectReference<MessageBubble>? _objRef;
    private IJSObjectReference? _chatModule;
    private string _componentId = Guid.NewGuid().ToString("N");
    private bool IsMenuOpen;
    private bool IsReactionOpen => OpenReactionMessageId == Message?.Id;
    private bool IsMine => Message?.SenderId == CurrentUserId;

    private void ToggleMenu() => IsMenuOpen = !IsMenuOpen;
    private void CloseMenu() => IsMenuOpen = false;

    private async Task HandleDeleteClick()
    {
        CloseMenu();
        if (IsMine) await OnDeleteRequested.InvokeAsync(Message);
        else await VM.DeleteMessageAsync(Message!.Id, false);
    }
    private string GetStatusClass()
    {
        return Message?.PersonalStatus.ToString().ToLower() ?? "sent";
    }
    private async Task HandleReaction(ReactionPayload payload)
    {
        if (Message?.Reactions?.CurrentUserReactionType == payload.Type)
            await OnReaction.InvokeAsync(new ReactionPayload { MessageId = payload.MessageId, Type = payload.Type });
        else await OnReaction.InvokeAsync(payload);
    }

    private Task OnReplyClick() => OnReplyRequested.InvokeAsync(Message!.Id);
    private Task OpenReactionDetails() => OnOpenReactionDetails.InvokeAsync(Message!.Id);
    private Task Retry() => OnRetry.InvokeAsync(Message!);
    private Task OnReplyPreviewClick() => (Message?.ReplyInfo != null && !Message.ReplyInfo.IsDeleted) ? OnScrollToMessage.InvokeAsync(Message.ReplyInfo.MessageId) : Task.CompletedTask;

    private string GroupPosClass => GroupPosition switch { "start" => "g-start", "mid" => "g-mid", "end" => "g-end", _ => "g-single" };
    private string StatusClass => Message?.PersonalStatus.ToString().ToLower() ?? "sent";
    private string GetSystemMessageType()
    {
        var lower = (Message!.Content ?? "").ToLower();
        if (lower.Contains("created")) return "create";
        if (lower.Contains("added")) return "join";
        if (lower.Contains("removed")) return "remove";
        if (lower.Contains("left")) return "leave";
        if (lower.Contains("pinned")) return "pin";
        return "";
    }
    private string PersonalStatusClass => Message?.PersonalStatus.ToString().ToLower() ?? "sent";
    private string GetSystemMessageText() => Message!.Content ?? "";

    private string GetReactionEmoji(ReactionType type) => type switch
    {
        ReactionType.Like => "👍",
        ReactionType.Love => "❤️",
        ReactionType.Laugh => "😂",
        ReactionType.Wow => "😮",
        ReactionType.Sad => "😢",
        ReactionType.Angry => "😠",
        ReactionType.Fire => "🔥",
        ReactionType.Party => "🎉",
        ReactionType.Clap => "👏",
        ReactionType.Pray => "🙏",
        _ => "❓"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            try
            {
                _chatModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/chatPage.js");
                await _chatModule.InvokeVoidAsync("registerClickOutside", _objRef, _componentId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Click outside registration failed: {ex.Message}");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_chatModule != null)
        {
            try { await _chatModule.InvokeVoidAsync("unregisterClickOutside", _componentId); } catch { }
            await _chatModule.DisposeAsync();
        }
        _objRef?.Dispose();
    }

    [JSInvokable]
    public async Task CloseAllPopups()
    {
        IsMenuOpen = false;
        if (IsReactionOpen)
        {
            await OnToggleReaction.InvokeAsync(Guid.Empty);
        }
        await InvokeAsync(StateHasChanged);
    }
}