@using EnterpriseChat.Client.Models
@using System.Linq
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components

@inject ApiClient Api

<div class="message-bubble @(IsMine ? "mine" : "theirs")">
    <div class="message-content">
        @Message.Content
    </div>

    <div class="message-meta">
        <span class="time">
            @Message.CreatedAt.ToShortTimeString()
        </span>

        @if (IsMine)
        {
            <span class="status @StatusClass"
                  title="@TooltipText"
                  @onmouseenter="LoadReadersIfNeeded">
                @StatusIcon
            </span>
            @if (Message.Status == MessageStatus.Failed)
            {
                <button class="retry-btn" @onclick="Retry">
                    Retry
                </button>
            }

        }
    </div>
</div>

@code {
    [Parameter] public MessageModel Message { get; set; } = default!;
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }

    private bool IsMine => Message.SenderId == CurrentUserId;
    private Task Retry()
    => OnRetry.InvokeAsync(Message);

    private string StatusIcon => Message.Status switch
    {
        MessageStatus.Sent => "✔",
        MessageStatus.Delivered => "✔✔",
        MessageStatus.Read => "✔✔",
        _ => ""
    };

    private string StatusClass => Message.Status switch
    {
        MessageStatus.Sent => "sent",
        MessageStatus.Delivered => "delivered",
        MessageStatus.Read => "read",
        _ => ""
    };

    private string _tooltipText = "Read";
    private bool _loaded;

    private string TooltipText => _tooltipText;

    private async Task LoadReadersIfNeeded()
    {
        if (_loaded || Message.Status != MessageStatus.Read)
            return;

        var readers = await Api.GetReadersAsync(Message.Id);

        _tooltipText =
            readers.Count == 0
                ? "Read"
                : $"Read by {string.Join(", ", readers.Select(r => r.UserId.ToString()[..6]))}";

        _loaded = true;
        await InvokeAsync(StateHasChanged);
    }
}
