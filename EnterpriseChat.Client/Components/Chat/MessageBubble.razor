@using EnterpriseChat.Client.Models
@using Microsoft.AspNetCore.Components

<div class="message-bubble @(IsMine ? "mine" : "theirs")">
    <div class="message-content">
        @Message.Content
    </div>

    <div class="message-meta">
        <span class="time">
            @Message.CreatedAt.ToShortTimeString()
        </span>

        @if (IsMine)
        {
            <span class="status @StatusClass"
                  title="@TooltipText">
                @StatusIcon
            </span>

            @if (Message.Status == MessageStatus.Failed)
            {
                <button class="retry-btn" @onclick="Retry">
                    Retry
                </button>
            }
        }
    </div>
</div>

@code {
    [Parameter] public MessageModel Message { get; set; } = default!;
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }

    private bool IsMine => Message.SenderId == CurrentUserId;

    private Task Retry()
        => OnRetry.InvokeAsync(Message);

    private string StatusIcon => Message.Status switch
    {
        MessageStatus.Sent => "✔",
        MessageStatus.Delivered => "✔✔",
        MessageStatus.Read => "✔✔",
        _ => ""
    };

    private string StatusClass => Message.Status switch
    {
        MessageStatus.Sent => "sent",
        MessageStatus.Delivered => "delivered",
        MessageStatus.Read => "read",
        _ => ""
    };

    private string TooltipText => Message.Status switch
    {
        MessageStatus.Sent => "Sent",
        MessageStatus.Delivered => "Delivered",
        MessageStatus.Read => "Read",
        MessageStatus.Failed => "Failed",
        _ => string.Empty
    };
}
