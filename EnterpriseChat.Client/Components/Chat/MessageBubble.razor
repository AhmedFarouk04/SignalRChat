@using EnterpriseChat.Client.Components.Reaction
@using EnterpriseChat.Client.Models
@using EnterpriseChat.Client.Services.Ui
@using EnterpriseChat.Client.ViewModels
@using EnterpriseChat.Domain.Enums
@using ClientMessageStatus = EnterpriseChat.Client.Models.MessageStatus
@using Microsoft.JSInterop
@using EnterpriseChat.Client.Services
@using System.ComponentModel

@inject ChatViewModel VM
@inject MenuStateService MenuState
@implements IAsyncDisposable
@implements IDisposable
@inject IJSRuntime JS

@if (Message != null)
{
    @if (IsMenuOpen || IsReactionOpen)
    {
        @* دي طبقة شفافة بتغطي الشاشة كلها أول ما المنيو أو الإيموجي يفتحوا *@
        <div class="menu-backdrop-overlay" @onclick="CloseAllPopups"></div>
    }
    <div class="msg-selection-wrapper @(IsMine ? "mine-wrapper" : "theirs-wrapper") @(VM.IsSelectionMode ? "selection-active" : "")"
         @onclick="() => { if (VM.IsSelectionMode) VM.ToggleMessageSelection(Message.Id); }">

        @if (VM.IsSelectionMode && !Message.IsDeleted)
        {
            <div class="custom-checkbox @(VM.SelectedMessageIds.Contains(Message.Id) ? "selected" : "")">
                @if (VM.SelectedMessageIds.Contains(Message.Id))
                {
                    <span class="check-mark">✓</span>
                }
            </div>
        }

        <div class="msg @(IsMine ? "mine" : "theirs") @GroupPosClass @(IsNew ? "new" : "") @(IsMenuOpen ? "menu-active" : "") @(IsReactionOpen ? "reactions-open" : "")"
             id="@($"message-{Message.Id}")">

            @if (!Message.IsDeleted)
            {
                <button class="quick-react-btn" type="button" @onclick:stopPropagation="true" @onclick="ToggleReactions">🙂</button>
            }

            <div class="msg-body @(Message.IsDeleted ? "deleted" : "")">

                @* الاسم جوا البابل - فوق على الشمال زي WhatsApp *@
                @if (GroupMembers.Count > 0 && !IsMine && GroupPosClass != "g-mid" && GroupPosClass != "g-end")
                {
                    var sender = GroupMembers.FirstOrDefault(m => m.Id == Message.SenderId);
                    var senderName = sender?.DisplayName ?? "Unknown";
                    var userColor = GetUserColor(senderName);

                    <div class="message-sender-name" style="@($"color: {userColor} !important")">
                        @senderName
                    </div>
                }

                @if (!Message.IsDeleted)
                {
                    <button class="msg-options-btn" type="button" @onclick:stopPropagation="true" @onclick="ToggleMenu">
                        <svg viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M3.3 4.6L9 10.3l5.7-5.7 1.6 1.6L9 13.5 1.7 6.2l1.6-1.6z"></path></svg>
                    </button>
                }

                @if (Message.ReplyInfo != null && !Message.IsDeleted)
                {
                    <div class="reply-preview" @onclick="OnReplyPreviewClick">
                        <div class="reply-header"><span>@(Message.ReplyInfo.SenderId == CurrentUserId ? "You" : Message.ReplyInfo.SenderName)</span></div>
                        <div class="reply-content">@(Message.ReplyInfo.IsDeleted ? "Deleted" : Message.ReplyInfo.ContentPreview)</div>
                    </div>
                }

                <div class="msg-text" dir="auto">
                    @if (Message.IsDeleted)
                    {
                        <em class="deleted-message">🚫 Deleted</em>
                    }
                    else
                    {
                        <MarkdownText Content="@Message.Content" />
                        @if (Message.IsEdited)
                        {
                            <span class="edited-badge">(edited)</span>
                        }
                    }
                </div>

                <div class="message-meta" dir="ltr">
                    <span class="message-time">@Message.CreatedAt.ToLocalTime().ToString("h:mm tt")</span>
                    @if (IsMine)
                    {
                        <span class="message-status-icon @GetStatusClass()">
                            @if (Message.PersonalStatus == ClientMessageStatus.Read)
                            {
                                <span class="status-icon read">✓✓</span>
                            }
                            else if (Message.PersonalStatus == ClientMessageStatus.Delivered)
                            {
                                <span class="status-icon delivered">✓✓</span>
                            }
                            else
                            {
                                <span class="status-icon sent">✓</span>
                            }
                        </span>
                    }
                </div>
            </div>

            @if (Message.Reactions?.Counts != null && Message.Reactions.Counts.Any())
            {
                <div class="msg-reaction-chip" @onclick:stopPropagation="true"
                     @onclick="() => OnOpenReactionDetails.InvokeAsync(Message.Id)">
                    @foreach (var kvp in Message.Reactions.Counts.OrderByDescending(x => x.Value).Take(3))
                    {
                        <span class="reaction-emoji">@GetReactionEmoji(kvp.Key)</span>
                    }
                    <span class="reaction-count">@Message.Reactions.Counts.Values.Sum()</span>
                </div>
            }

            @if (IsMenuOpen)
            {
                <div class="msg-context-menu" @onclick:stopPropagation="true">
                    <button class="menu-item" @onclick="async () => { CloseMenu(); await OnReplyClick(); }">↩️ Reply</button>

                    @if (!Message.IsDeleted)
                    {
                        <button class="menu-item" @onclick="HandlePinClick">
                            @(VM.IsMessagePinned(Message.Id) ? "📌 Unpin" : "📌 Pin")
                        </button>

                        @* ✅ زرار Forward الجديد *@
                        <button class="menu-item" @onclick="HandleForwardClick">➤ Forward</button>
                    }

                    @if (IsMine && !Message.IsDeleted)
                    {
                        <button class="menu-item" @onclick="() => { CloseMenu(); OnEditRequested.InvokeAsync(Message); }">✏️ Edit</button>
                    }

                    <button class="menu-item delete" @onclick="HandleDeleteClick">🗑️ Delete</button>
                </div>
            }
            @if (IsReactionOpen)
            {
                <div class="reactions-hover-wrap" @onclick:stopPropagation="true">
                    <ReactionsPanel MessageId="@Message.Id" Reactions="@Message.Reactions" OnReaction="HandleReaction" />
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public MessageModel? Message { get; set; }
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public List<UserModel> GroupMembers { get; set; } = new();
    [Parameter] public string GroupPosition { get; set; } = "single";
    [Parameter] public bool IsNew { get; set; }
    [Parameter] public bool ShowMeta { get; set; } = true;
    [Parameter] public Guid? OpenReactionMessageId { get; set; }
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }
    [Parameter] public EventCallback<ReactionPayload> OnReaction { get; set; }
    [Parameter] public EventCallback<Guid> OnReplyRequested { get; set; }
    [Parameter] public EventCallback<Guid> OnScrollToMessage { get; set; }
    [Parameter] public EventCallback<Guid> OnOpenReactionDetails { get; set; }
    [Parameter] public EventCallback<Guid> OnToggleReaction { get; set; }
    [Parameter] public EventCallback<MessageModel> OnEditRequested { get; set; }
    [Parameter] public EventCallback<MessageModel> OnDeleteRequested { get; set; }

    private DotNetObjectReference<MessageBubble>? _clickObjRef;

    private bool IsMenuOpen => MenuState.OpenMenuMessageId == Message?.Id;
    private bool IsReactionOpen => OpenReactionMessageId == Message?.Id;
    private bool IsMine => Message?.SenderId == CurrentUserId;
    private string GroupPosClass => GroupPosition switch { "start" => "g-start", "mid" => "g-mid", "end" => "g-end", _ => "g-single" };

    protected override void OnInitialized()
    {
        if (Message != null)
            Message.PropertyChanged += OnMessagePropertyChanged;
        MenuState.PropertyChanged += OnMenuStateChanged;
        VM.SelectionModeChanged += OnSelectionModeChanged; // ✅ أضف ده

    }
    private void OnMenuStateChanged(object? s, PropertyChangedEventArgs e) => InvokeAsync(StateHasChanged);
    private void OnSelectionModeChanged() => InvokeAsync(StateHasChanged); // ✅ أضف ده

    private void HandleForwardClick()
    {
        CloseMenu();
        VM.IsSelectionMode = true;
        VM.SelectedMessageIds.Clear();
        VM.SelectedMessageIds.Add(Message!.Id);
    }
    private void OnMessagePropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (Message != null)
            Message.PropertyChanged -= OnMessagePropertyChanged;
        MenuState.PropertyChanged -= (s, e) => { };
        VM.SelectionModeChanged -= OnSelectionModeChanged;
    }

    private async Task ToggleMenu()
    {
        if (!IsMenuOpen)
        {
            await OnToggleReaction.InvokeAsync(Guid.Empty); // اقفل الإيموجي الأول
            MenuState.OpenMenuMessageId = Message?.Id;
        }
        else { CloseMenu(); }
    }
    private void CloseMenu() => MenuState.CloseMenu();


    private async Task ToggleReactions()
    {
        if (!IsReactionOpen)
        {
            CloseMenu(); // اقفل المنيو الأول
            await OnToggleReaction.InvokeAsync(Message!.Id);
        }
        else { await OnToggleReaction.InvokeAsync(Guid.Empty); }
    }

    // الدالة السحرية اللي هتقفل كل حاجة لما تضغط برا
    private async Task CloseAllPopups()
    {
        CloseMenu();
        await OnToggleReaction.InvokeAsync(Guid.Empty);
        StateHasChanged();
    }




    private async Task HandleDeleteClick() { CloseMenu(); await OnDeleteRequested.InvokeAsync(Message); }
    private string GetStatusClass() => Message?.PersonalStatus.ToString().ToLower() ?? "sent";

    private async Task HandleReaction(ReactionPayload p) { await OnReaction.InvokeAsync(p); await OnToggleReaction.InvokeAsync(Guid.Empty); }
    private Task OnReplyClick() => OnReplyRequested.InvokeAsync(Message!.Id);
    private Task OnReplyPreviewClick() => Message?.ReplyInfo != null ? OnScrollToMessage.InvokeAsync(Message.ReplyInfo.MessageId) : Task.CompletedTask;

    private string GetReactionEmoji(ReactionType t) => t switch
    {
        ReactionType.Like => "👍",
        ReactionType.Love => "❤️",
        ReactionType.Laugh => "😂",
        ReactionType.Wow => "😮",
        ReactionType.Sad => "😢",
        ReactionType.Angry => "😠",
        ReactionType.ThumbsDown => "👎",
        ReactionType.Fire => "🔥",
        ReactionType.Party => "🎉",
        ReactionType.Clap => "👏",
        ReactionType.Pray => "🙏",
        _ => "❓"
    };

    private string GetStatusTooltip() => "";

    public async ValueTask DisposeAsync()
    {
        if (_clickObjRef != null)
        {
            await JS.InvokeVoidAsync("unregisterClickHandler");
            _clickObjRef.Dispose();
            _clickObjRef = null;
        }
        if (Message != null) Message.PropertyChanged -= (s, e) => { };
        MenuState.PropertyChanged -= (s, e) => { };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Message != null)
        {
            _clickObjRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("registerClickHandler", _clickObjRef);
        }
    }

    [JSInvokable]
    public async Task OnDocumentClick()
    {
        bool needsRefresh = false;

        if (IsMenuOpen)
        {
            MenuState.CloseMenu();
            needsRefresh = true;
        }

        if (IsReactionOpen)
        {
            await OnToggleReaction.InvokeAsync(Guid.Empty);
            needsRefresh = true;
        }

        if (needsRefresh)
        {
            await InvokeAsync(StateHasChanged);
        }
    }
    private void HandlePinClick()
    {
        CloseMenu();
        VM.OpenPinModal(Message!.Id);
    }
    private string GetUserColor(string userName)
    {
        if (string.IsNullOrEmpty(userName)) return "#94a3b8";
        var colors = new[]
        {
            "#E91E63", "#9C27B0", "#673AB7", "#3F51B5", "#2196F3", "#03A9F4", "#00BCD4",
            "#009688", "#4CAF50", "#8BC34A", "#CDDC39", "#FFC107", "#FF9800", "#FF5722",
            "#795548", "#607D8B", "#F44336", "#FFEB3B", "#8BC34A", "#00E676", "#18FFFF",
            "#B388FF", "#FF4081", "#64DD17", "#FF6E40", "#AA00FF", "#0091EA", "#C51162"
        };
        var hash = userName.GetHashCode();
        return colors[Math.Abs(hash) % colors.Length];
    }
}