@using EnterpriseChat.Client.Models

<div class="msg @(IsMine ? "mine" : "theirs") @(GroupPosClass) @(IsNew ? "new" : "")">
    <div class="msg-body">
        <div class="msg-text">@Message.Content</div>
    </div>

    @if (ShowMeta)
    {
        <div class="msg-meta">
            <span class="time">@Message.CreatedAt.ToLocalTime().ToShortTimeString()</span>

            @if (IsMine)
            {
                <span class="status @StatusClass" title="@TooltipText">@StatusIcon</span>

                @if (Message.Status == MessageStatus.Failed)
                {
                    <button class="retry-btn" @onclick="Retry">Retry</button>
                }
            }
        </div>
    }
</div>

@code {
    [Parameter] public MessageModel Message { get; set; } = default!;
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }

    [Parameter] public string GroupPosition { get; set; } = "single"; // single|start|mid|end
    [Parameter] public bool ShowMeta { get; set; } = true;
    [Parameter] public bool IsNew { get; set; }

    private bool IsMine => Message.SenderId == CurrentUserId;

    private string GroupPosClass => GroupPosition switch
    {
        "start" => "g-start",
        "mid" => "g-mid",
        "end" => "g-end",
        _ => "g-single"
    };

    private Task Retry() => OnRetry.InvokeAsync(Message);

    private string StatusIcon => Message.Status switch
    {
        MessageStatus.Pending => "…",
        MessageStatus.Sent => "✓",
        MessageStatus.Delivered => "✓✓",
        MessageStatus.Read => "✓✓",
        MessageStatus.Failed => "!",
        _ => ""
    };

    private string StatusClass => Message.Status switch
    {
        MessageStatus.Pending => "pending",
        MessageStatus.Sent => "sent",
        MessageStatus.Delivered => "delivered",
        MessageStatus.Read => "read",
        MessageStatus.Failed => "failed",
        _ => ""
    };

    private string TooltipText => Message.Status switch
    {
        MessageStatus.Pending => "Sending…",
        MessageStatus.Sent => "Sent",
        MessageStatus.Delivered => "Delivered",
        MessageStatus.Read => "Read",
        MessageStatus.Failed => "Failed",
        _ => ""
    };
}
