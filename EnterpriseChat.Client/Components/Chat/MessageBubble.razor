@using EnterpriseChat.Client.Models
@using EnterpriseChat.Domain.Enums
@using ClientMessageStatus = EnterpriseChat.Client.Models.MessageStatus
@inject NavigationManager Navigation

@{
    var systemType = GetSystemMessageType();
    var isSystem = !string.IsNullOrEmpty(systemType);
    var systemIcon = GetSystemIcon(systemType);
    var showSystemTime = isSystem;
}

@if (isSystem)
{
    <div class="system-message-container" id="@($"message-{Message.Id}")">
        <div class="system-message @systemType">
            <div class="system-content">
                @if (!string.IsNullOrEmpty(systemIcon))
                {
                    <span class="system-icon">@systemIcon</span>
                }

                <span class="system-text">@GetSystemMessageText()</span>

                @if (showSystemTime)
                {
                    <span class="system-time">@Message.CreatedAt.ToLocalTime().ToString("h:mm tt")</span>
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="msg @(IsMine ? "mine" : "theirs") @GroupPosClass @(IsNew ? "new" : "")" 
         id="@($"message-{Message.Id}")"
         @onclick="OnMessageClick">
        
        <!-- ✅ Reply Preview -->
        @if (Message.ReplyInfo != null && !Message.IsDeleted)
        {
            <div class="reply-preview" @onclick="OnReplyPreviewClick">
                <div class="reply-header">
                    <span class="reply-sender">@Message.ReplyInfo.SenderName</span>
                    @if (Message.ReplyInfo.IsDeleted)
                    {
                        <span class="reply-deleted">[Deleted]</span>
                    }
                </div>
                <div class="reply-content">
                    @if (Message.ReplyInfo.IsDeleted)
                    {
                        <em>This message was deleted</em>
                    }
                    else
                    {
                        @Message.ReplyInfo.ContentPreview
                    }
                </div>
                <div class="reply-line"></div>
            </div>
        }
        
        <div class="msg-body">
            <div class="msg-text">
                @if (Message.IsDeleted)
                {
                    <em class="deleted-message">This message was deleted</em>
                }
                else
                {
                    @if (IsMine)
                    {
                        <MarkdownText Content="@Message.Content" />
                    }
                    else
                    {
                        <MarkdownText Content="@Message.Content" />
                    }
                    
                    @if (Message.IsEdited)
                    {
                        <span class="edited-badge" title="Edited at @Message.UpdatedAt?.ToLocalTime()">
                            (edited)
                        </span>
                    }
                }
            </div>
        </div>

        @if (ShowReactions && Message.Reactions?.Counts.Any() == true)
        {
            <div class="message-reactions">
                @foreach (var kv in Message.Reactions.Counts.OrderByDescending(x => x.Value))
                {
                    <span class="reaction-item" 
                          @onclick="() => ShowReactionDetails(kv.Key)"
                          title="@GetReactionUsers(kv.Key)">
                        @GetReactionEmoji(kv.Key) @kv.Value
                    </span>
                }
            </div>
        }

        <ReactionsPanel MessageId="@Message.Id" 
                        Reactions="@Message.Reactions"
                        OnReaction="@OnReactionClicked" />

        @if (IsMine)
        {
            @if (Message.Status == ClientMessageStatus.Read && Message.ReadCount > 0)
            {
                <span class="read-stats" title="@Message.ReadCount of @Message.TotalRecipients read">
                    (@Message.ReadCount/@Message.TotalRecipients)
                </span>
            }
            else if (Message.Status == ClientMessageStatus.Delivered && Message.DeliveredCount > 0)
            {
                <span class="delivered-stats" title="@Message.DeliveredCount of @Message.TotalRecipients delivered">
                    (@Message.DeliveredCount/@Message.TotalRecipients)
                </span>
            }
        }
        
        <!-- ✅ الحالة والتوقيت -->
        <div class="message-meta">
            <span class="message-time">
                @Message.CreatedAt.ToLocalTime().ToString("HH:mm")
            </span>
            
            @if (IsMine)
            {
                <span class="message-status @StatusClass" title="@TooltipText"></span>
            }
        </div>
    </div>
}

@code {
    [Parameter] public MessageModel Message { get; set; } = default!;
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }
    [Parameter] public RoomModel? Room { get; set; }
    [Parameter] public List<UserModel> GroupMembers { get; set; } = new();
    [Parameter] public string GroupPosition { get; set; } = "single";
    [Parameter] public bool ShowMeta { get; set; } = true;
    [Parameter] public bool IsNew { get; set; } = false;
    [Parameter] public EventCallback<ReactionType> OnReaction { get; set; }
    [Parameter] public EventCallback<Guid> OnReplyRequested { get; set; }
    [Parameter] public EventCallback<Guid> OnScrollToMessage { get; set; }

    private bool ShowReactions => true;
    private bool IsMine => Message.SenderId == CurrentUserId;

    private string GroupPosClass => GroupPosition switch
    {
        "start" => "g-start",
        "mid" => "g-mid",
        "end" => "g-end",
        _ => "g-single"
    };

    private string StatusClass => Message.Status switch
    {
        ClientMessageStatus.Pending => "pending",
        ClientMessageStatus.Sent => "sent",
        ClientMessageStatus.Delivered => "delivered",
        ClientMessageStatus.Read => "read",
        ClientMessageStatus.Failed => "failed",
        _ => ""
    };

    private string TooltipText => Message.Status switch
    {
        ClientMessageStatus.Pending => "Sending…",
        ClientMessageStatus.Sent => "Sent",
        ClientMessageStatus.Delivered => "Delivered",
        ClientMessageStatus.Read => "Read",
        ClientMessageStatus.Failed => "Failed",
        _ => ""
    };

    private string GetSystemMessageType()
    {
        var lower = (Message.Content ?? "").ToLower();

        if (lower.Contains("created") || lower.Contains("created the group"))
            return "create";
        else if (lower.Contains("added") || lower.Contains("joined"))
            return "join";
        else if (lower.Contains("removed"))
            return "remove";
        else if (lower.Contains("left") || lower.Contains("leave"))
            return "leave";
        else if (lower.Contains("rename") || lower.Contains("changed"))
            return "rename";
        else
            return "";
    }

    private string GetSystemIcon(string type) => type switch
    {
        "create" => "🏗️",
        "join" => "➕",
        "remove" => "➖",
        "leave" => "👋",
        "rename" => "✏️",
        _ => ""
    };

    private string GetSystemMessageText()
    {
        return (Message.Content ?? "")
            .Replace("was added", "added")
            .Replace("was removed", "removed")
            .Replace("created the group", "created group")
            .Replace("was added by", "added by")
            .Replace("was removed by", "removed by");
    }

    private string GetReactionEmoji(ReactionType type) => type switch
    {
        ReactionType.Like => "👍",
        ReactionType.Love => "❤️",
        ReactionType.Laugh => "😂",
        ReactionType.Wow => "😮",
        ReactionType.Sad => "😢",
        ReactionType.Angry => "😠",
        ReactionType.ThumbsUp => "👍",
        ReactionType.ThumbsDown => "👎",
        ReactionType.Fire => "🔥",
        ReactionType.Party => "🎉",
        ReactionType.Clap => "👏",
        ReactionType.Pray => "🙏",
        _ => "❓"
    };

    private string GetReactionUsers(ReactionType type)
    {
        if (Message.Reactions?.UsersByType.TryGetValue(type, out var users) == true)
        {
            var userNames = users.Select(u => u.DisplayName).Take(3);
            return $"{string.Join(", ", userNames)}" +
                   (users.Count > 3 ? $" and {users.Count - 3} more" : "");
        }
        return "";
    }

    private void ShowReactionDetails(ReactionType type)
    {
        Console.WriteLine($"Showing details for reaction: {type}");
    }

    private async Task OnReactionClicked(ReactionType type)
    {
        await OnReaction.InvokeAsync(type);
    }
    private async Task OnMessageClick()
    {
        // عند الضغط على الرسالة، اعرض خيارات الرد
        await OnReplyRequested.InvokeAsync(Message.Id);
    }

    private async Task OnReplyPreviewClick()
    {
        if (Message.ReplyInfo != null && !Message.ReplyInfo.IsDeleted)
        {
            // انتقل إلى الرسالة الأصلية
            await OnScrollToMessage.InvokeAsync(Message.ReplyInfo.MessageId);
        }
    }
   
}