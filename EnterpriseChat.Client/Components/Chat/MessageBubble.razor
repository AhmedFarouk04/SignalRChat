@using EnterpriseChat.Client.Models

<div class="msg @(IsMine ? "mine" : "theirs") @(GroupPosClass) @(IsNew ? "new" : "")">
    <div class="msg-body">
        <div class="msg-text">@Message.Content</div>
    </div>

    @if (ShowMeta)
    {
        <div class="msg-meta">
            <span class="time">@Message.CreatedAt.ToLocalTime().ToShortTimeString()</span>

            @if (IsMine)
            {
                <span class="status @StatusClass" title="@TooltipText">@StatusIcon</span>
            }
        </div>
    }
</div>

@code {
    [Parameter] public MessageModel Message { get; set; } = default!;
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }
    [Parameter] public RoomModel? Room { get; set; }
    [Parameter] public List<UserModel> GroupMembers { get; set; } = new();
    [Parameter] public string GroupPosition { get; set; } = "single";
    [Parameter] public bool ShowMeta { get; set; } = true;
    [Parameter] public bool IsNew { get; set; }

    private bool IsMine => Message.SenderId == CurrentUserId;

    private string GroupPosClass => GroupPosition switch
    {
        "start" => "g-start",
        "mid" => "g-mid",
        "end" => "g-end",
        _ => "g-single"
    };

    private string StatusIcon => Message.Status switch
    {
        MessageStatus.Pending => "…",
        MessageStatus.Sent => "✓",
        MessageStatus.Delivered => "✓✓",
        MessageStatus.Read => "✓✓ 👁",
        MessageStatus.Failed => "!",
        _ => ""
    };

    private string StatusClass => ((int)Message.Status) switch
    {
        (int)MessageStatus.Pending => "pending",
        (int)MessageStatus.Sent => "sent",
        (int)MessageStatus.Delivered => "delivered",
        (int)MessageStatus.Read => "read",
        (int)MessageStatus.Failed => "failed",
        _ => ""
    };

    private string TooltipText => ((int)Message.Status) switch
    {
        (int)MessageStatus.Pending => "Sending…",
        (int)MessageStatus.Sent => "Sent",
        (int)MessageStatus.Delivered => "Delivered",
        (int)MessageStatus.Read => "Read",
        (int)MessageStatus.Failed => "Failed",
        _ => ""
    };
}