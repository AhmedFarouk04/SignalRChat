@using EnterpriseChat.Client.Models
@using Microsoft.JSInterop
@inject IJSRuntime JS

<div class="message-list"
     @ref="listRef"
     @onscroll="OnScroll">

    @if (showUnreadDivider)
    {
        <div class="unread-divider">
            Unread messages
        </div>
    }

    @foreach (var msg in Messages)
    {
        <MessageBubble Message="msg"
                       CurrentUserId="CurrentUserId"
                       OnRetry="OnRetry" />
    }
</div>

@code {
    [Parameter] public IReadOnlyList<MessageModel> Messages { get; set; } = [];
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public EventCallback<MessageModel> OnRetry { get; set; }
    [Parameter] public EventCallback<Guid> OnReachedBottom { get; set; }

    [Parameter] public bool AutoScroll { get; set; } = true;

    private ElementReference listRef;

    private int lastMessageCount;
    private bool isAtBottom = true;
    private bool showUnreadDivider;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (listRef.Context is null)
            return;

        if (firstRender)
        {
            if (AutoScroll)
                await JS.InvokeVoidAsync("scrollHelper.scrollToBottom", listRef);

            lastMessageCount = Messages.Count;
            return;
        }

        if (Messages.Count == lastMessageCount)
            return;

        if (Messages.Count > lastMessageCount)
        {
            isAtBottom = await JS.InvokeAsync<bool>("scrollHelper.isAtBottom", listRef);

            if (AutoScroll && isAtBottom)
            {
                await JS.InvokeVoidAsync("scrollHelper.scrollToBottom", listRef);
                showUnreadDivider = false;

                if (Messages.Count > 0)
                    await OnReachedBottom.InvokeAsync(Messages[^1].Id);
            }
            else
            {
                showUnreadDivider = true;
            }
        }

        lastMessageCount = Messages.Count;
    }

    private async Task OnScroll()
    {
        if (listRef.Context is null)
            return;

        isAtBottom = await JS.InvokeAsync<bool>("scrollHelper.isAtBottom", listRef);

        if (isAtBottom)
        {
            showUnreadDivider = false;

            if (Messages.Count > 0)
                await OnReachedBottom.InvokeAsync(Messages[^1].Id);
        }
    }
}
