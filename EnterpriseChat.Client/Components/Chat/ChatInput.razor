@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JS

<div class="composer">
    <div class="composer-box">
        <textarea class="composer-input"
                  @ref="inputRef"
                  placeholder="Message…"
                  @bind-value="text"
                  @bind-value:event="oninput"
                  @onkeydown="OnKeyDown"></textarea>



        <button class="composer-send"
                type="button"
                disabled="@IsSendDisabled"
                @onclick="Send">
            Send
        </button>
    </div>
</div>

@code {
    private string text = string.Empty;
    private ElementReference inputRef;

    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback OnUserTyping { get; set; }

    private bool IsSendDisabled => string.IsNullOrWhiteSpace(text);

    private CancellationTokenSource? _typingCts;
    private DateTime _lastTypingSent = DateTime.MinValue;

    private static readonly HashSet<string> IgnoreKeys = new()
{
    "Shift","Control","Alt","Meta",
    "ArrowUp","ArrowDown","ArrowLeft","ArrowRight",
    "Escape","Tab","CapsLock"
};

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await Send();
            return;
        }

        if (IgnoreKeys.Contains(e.Key))
            return;

        await OnUserTyping.InvokeAsync();
    }


    private async Task OnInput(ChangeEventArgs _)
    {
        // input بيغطي paste + mobile keyboards
        await DebouncedTypingAsync();
    }

    private static bool IsNonTypingKey(string key)
        => key is "Shift" or "Control" or "Alt" or "Meta"
            or "ArrowUp" or "ArrowDown" or "ArrowLeft" or "ArrowRight"
            or "CapsLock" or "Tab" or "Escape";

    private async Task DebouncedTypingAsync()
    {
        // throttle: ابعت بحد أقصى مرة كل 700ms
        var now = DateTime.UtcNow;
        if ((now - _lastTypingSent).TotalMilliseconds < 700) return;

        _typingCts?.Cancel();
        _typingCts?.Dispose();
        _typingCts = new CancellationTokenSource();
        var ct = _typingCts.Token;

        try
        {
            await Task.Delay(120, ct); // debounce صغير
            if (ct.IsCancellationRequested) return;

            _lastTypingSent = DateTime.UtcNow;
            await OnUserTyping.InvokeAsync();
        }
        catch { }
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(text)) return;

        var toSend = text.TrimEnd();
        text = string.Empty;

        await OnSend.InvokeAsync(toSend);
        await JS.InvokeVoidAsync("chatFocus", inputRef);
    }

    public void Dispose()
    {
        _typingCts?.Cancel();
        _typingCts?.Dispose();
    }
}
