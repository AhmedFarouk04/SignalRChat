@using Microsoft.AspNetCore.Components.Web
@inject IJSRuntime JS

<div class="composer">
    <div class="composer-box">
        <textarea class="composer-input"
                  @ref="inputRef"
                  placeholder="Message…"
                  value="@text"
                  @oninput="OnInput"
                  @onkeydown="OnKeyDown"
                  @onkeydown:preventDefault="true"></textarea>

        <button class="composer-send"
                type="button"
                disabled="@IsSendDisabled"
                @onclick="Send">
            Send
        </button>
    </div>
</div>

@code {
    private string text = string.Empty;
    private ElementReference inputRef;

    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback OnUserTyping { get; set; }

    private bool IsSendDisabled => string.IsNullOrWhiteSpace(text);

    private async Task OnInput(ChangeEventArgs e)
    {
        text = e.Value?.ToString() ?? string.Empty;
        await OnUserTyping.InvokeAsync();
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter")
            return;

        if (e.ShiftKey)
        {
            // insert newline at cursor (JS) + triggers input event => text updates
            await JS.InvokeVoidAsync("chatInsertNewline", inputRef);
            await OnUserTyping.InvokeAsync();
            return;
        }

        await Send();
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(text))
            return;

        var toSend = text.TrimEnd();
        text = string.Empty;

        await OnSend.InvokeAsync(toSend);
        await JS.InvokeVoidAsync("chatFocus", inputRef);
    }
}
