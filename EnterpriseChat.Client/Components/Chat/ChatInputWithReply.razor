@using EnterpriseChat.Client.Models
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject EnterpriseChat.Client.Models.ReplyContext ReplyCtx

<div class="composer">
    @if (ReplyCtx.MessageId != Guid.Empty)
    {
        <div class="reply-context">
            <div class="reply-header">
                <span>Replying to @ReplyCtx.SenderName</span>
                <button class="cancel-reply" @onclick="CancelReply" type="button">✕</button>
            </div>
            <div class="reply-preview-text">@ReplyCtx.ContentPreview</div>
        </div>
    }

    <div class="composer-box">
        <textarea class="composer-input"
                  @ref="inputRef"
                  placeholder="@(ReplyCtx.MessageId != Guid.Empty ? "Type your reply…" : "Message…")"
                  @bind-value="text"
                  @bind-value:event="oninput"
                  @onkeydown="OnKeyDown">
        </textarea>

        <button class="composer-send"
                type="button"
                disabled="@IsSendDisabled"
                @onclick="Send">
            Send
        </button>
    </div>
</div>

@code {
    private string text = string.Empty;
    private ElementReference inputRef;

    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback OnUserTyping { get; set; }

    private bool IsSendDisabled => string.IsNullOrWhiteSpace(text);

    private static readonly HashSet<string> IgnoreKeys = new()
    {
        "Shift","Control","Alt","Meta",
        "ArrowUp","ArrowDown","ArrowLeft","ArrowRight",
        "Escape","Tab","CapsLock"
    };

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await Send();
            return;
        }

        if (IgnoreKeys.Contains(e.Key))
            return;

        await OnUserTyping.InvokeAsync();
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(text)) return;

        var toSend = text.TrimEnd();
        text = string.Empty;

        await OnSend.InvokeAsync(toSend);

        ReplyCtx.Clear();
        await JS.InvokeVoidAsync("chatFocus", inputRef);
    }

    private void CancelReply()
    {
        ReplyCtx.Clear();
    }
}
