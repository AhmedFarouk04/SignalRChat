@using EnterpriseChat.Client.Models
@using Microsoft.AspNetCore.Components.Routing

<li>
    <NavLink class="room-link"
             ActiveClass="active"
             href="@($"/chat/{Room.Id}")"
             Match="NavLinkMatch.Prefix">

        @if (Room.Type == "Group")
        {
            <div class="room-avatar group" aria-label="Group chat">👥</div>
        }
        else
        {
            <div class="room-avatar private" aria-label="Private chat" style="position: relative; overflow: visible;">
                <span class="avatar-text">@GetAvatarText()</span>

                @if (IsOnline == true)
                {
                    <span class="online-dot" title="Online" aria-label="Online"></span>
                }
                else if (!string.IsNullOrEmpty(LastSeenText))
                {
                    <span class="last-seen-dot" title="@LastSeenText" aria-label="Last seen">⏱️</span>
                }
            </div>
        }

        <div class="room-main">
            <div class="room-top">
                <div class="room-title">@Room.Name</div>
                <div class="room-meta">
                    @if (Room.IsMuted)
                    {
                        <span class="mute">🔕</span>
                    }
                    @if (Room.UnreadCount > 0)
                    {
                        <span class="badge">@Room.UnreadCount</span>
                    }
                    @if (Room.LastMessageAt != null)
                    {
                        <span class="room-time">@FormatTime(Room.LastMessageAt.Value)</span>
                    }
                </div>
            </div>

            <div class="room-preview" title="@Room.LastMessagePreview">
                @if (IsTyping)
                {
                    <span class="typing-group-text">
                        <span class="typing-dots-room">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                        @if (!string.IsNullOrEmpty(TypingText))
                        {
                            <span>@TypingText</span>
                        }
                    </span>
                }
                else if (!string.IsNullOrWhiteSpace(Room.LastMessagePreview))
                {
                    var sender = GetSenderInfo();

                    @* 1. عرض علامة الصح (Status) لو أنا المرسل *@
                    @if (IsMyLastMessage && Room.LastMessageStatus.HasValue && Room.LastMessageSenderId != Guid.Empty)
                    {
                        <span class="room-last-status @GetStatusClass(Room.LastMessageStatus.Value)">
                            @StatusIcon(Room.LastMessageStatus.Value)
                        </span>
                        <span>&nbsp;</span>
                    }

                    @* 2. عرض اسم المرسل *@
                    @if (!string.IsNullOrEmpty(sender.name))
                    {
                        <span class="message-sender" style="font-weight: bold; color: #aaa;">@sender.name: </span>
                    }

                    <span class="@(Room.LastMessageSenderId == Guid.Empty ? "system-message-preview" : "")">
                        @Truncate(Room.LastMessagePreview, 60)
                    </span>
                }
            </div>
        </div>
    </NavLink>
</li>

@code {
    [Parameter, EditorRequired] public RoomListItemModel Room { get; set; } = default!;
    [Parameter] public bool? IsOnline { get; set; }
    [Parameter] public string? LastSeenText { get; set; }
    [Parameter] public bool IsTyping { get; set; }
    [Parameter] public Guid CurrentUserId { get; set; }
    [Parameter] public string? TypingText { get; set; }
    private bool IsMyLastMessage => Room.LastMessageSenderId == CurrentUserId;
    private static string GetStatusClass(MessageStatus status) => status switch
    {
        MessageStatus.Pending => "pending",
        MessageStatus.Sent => "sent",
        MessageStatus.Delivered => "delivered",
        MessageStatus.Read => "read",
        MessageStatus.Failed => "failed",
        _ => ""
    };

    private static string StatusIcon(MessageStatus st) => st switch
    {
        MessageStatus.Pending => "…",
        MessageStatus.Sent => "✓",
        MessageStatus.Delivered => "✓✓",
        MessageStatus.Read => "✓✓",
        MessageStatus.Failed => "!",
        _ => ""
    };

    private static string StatusTooltip(MessageStatus st) => st switch
    {
        MessageStatus.Pending => "Sending…",
        MessageStatus.Sent => "Sent",
        MessageStatus.Delivered => "Delivered",
        MessageStatus.Read => "Read",
        MessageStatus.Failed => "Failed",
        _ => ""
    };

    private static string FormatTime(DateTime utc)
    {
        var dt = utc.ToLocalTime();
        var today = DateTime.Now.Date;
        if (dt.Date == today) return dt.ToShortTimeString();
        if (dt.Date == today.AddDays(-1)) return "Yesterday";
        return dt.ToString("dd MMM");
    }

    private string GetAvatarText()
    {
        if (Room.Type == "Private" && !string.IsNullOrWhiteSpace(Room.OtherDisplayName))
            return Room.OtherDisplayName.Substring(0, 1).ToUpper();

        return Room.Name.Substring(0, 1).ToUpper();
    }


    private (string? name, string? color) GetSenderInfo()
    {
        if (Room.LastMessageSenderId == null || Room.LastMessageSenderId == Guid.Empty)
            return (null, null);

        if (Room.Type == "Private")
            return (null, null); // ✅ الخاص: مفيش اسم خالص

        if (Room.LastMessageSenderId == CurrentUserId)
            return ("You", null);

        if (Room.MemberNames != null && Room.MemberNames.TryGetValue(Room.LastMessageSenderId.Value, out var name))
            return (name.Split(' ')[0], null);

        return ("Unknown", null);
    }

    private static string Truncate(string? text, int max)
    {
        if (string.IsNullOrWhiteSpace(text)) return string.Empty;
        text = text.Trim();
        if (text.Length <= max) return text;
        return text.Substring(0, max - 1) + "…";
    }

    protected override void OnParametersSet()
    {
        Console.WriteLine($"[RoomListItem] 🏠 Rendering: {Room.Name}");
        base.OnParametersSet();
    }

    protected override bool ShouldRender()
    {
        return true;
    }
}