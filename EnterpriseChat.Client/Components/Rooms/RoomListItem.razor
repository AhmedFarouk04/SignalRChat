@using EnterpriseChat.Client.Models
@using Microsoft.AspNetCore.Components.Routing

<li>
    <NavLink class="room-link"
             ActiveClass="active"
             href="@($"/chat/{Room.Id}")"
             Match="NavLinkMatch.Prefix">

        @if (Room.Type == "Group")
        {
            <div class="room-avatar group" aria-label="Group chat">👥</div>
        }
        else
        {
            <div class="room-avatar private" aria-label="Private chat">
                <span class="avatar-text">@GetAvatarText()</span>

                @if (IsOnline == true)
                {
                    <span class="online-dot" title="Online" aria-label="Online"></span>
                }
            </div>

        }

        <div class="room-main">
            <div class="room-top">
                <div class="room-title">@Room.Name</div>

                <div class="room-meta">
                    @if (IsTyping)
                    {
                        <span class="typing-dot" title="Typing…" aria-label="Typing"></span>
                    }

                    @if (Room.IsMuted)
                    {
                        <span class="mute" title="Muted" aria-label="Muted">🔕</span>
                    }

                    @if (Room.UnreadCount > 0)
                    {
                        <span class="badge" aria-label="@($"{Room.UnreadCount} unread")">@Room.UnreadCount</span>
                    }

                    @if (Room.LastMessageAt != null)
                    {
                        <span class="room-time">@FormatTime(Room.LastMessageAt.Value)</span>
                    }
                </div>
            </div>

            @* ✅ ما نعرضش أي preview لو فاضي (نلغي Tap to open chat) *@
            @if (!string.IsNullOrWhiteSpace(Room.LastMessagePreview))
            {
                <div class="room-preview" title="@Room.LastMessagePreview">
                    @if (IsMyLastMessage && Room.LastMessageStatus.HasValue)
                    {
                        <span class="room-last-status" title="@StatusTooltip(Room.LastMessageStatus.Value)">
                            @StatusIcon(Room.LastMessageStatus.Value)
                        </span>
                        <span>&nbsp;</span>
                    }
                    @Truncate(Room.LastMessagePreview, 60)
                </div>
            }

        </div>

    </NavLink>
</li>

@code {
    [Parameter, EditorRequired] public RoomListItemModel Room { get; set; } = default!;
    [Parameter] public bool? IsOnline { get; set; } // null = unknown/loading
    [Parameter] public string? LastSeenText { get; set; }
    [Parameter] public bool IsTyping { get; set; }
    // ✅ we can't know current user id هنا، فنعتمد على إن السيرفر بيبعت status فقط لو last msg is mine
    private bool IsMyLastMessage => Room.LastMessageStatus.HasValue;

    private static string StatusIcon(MessageStatus st) => st switch
    {
        MessageStatus.Pending => "…",
        MessageStatus.Sent => "✓",
        MessageStatus.Delivered => "✓✓",
        MessageStatus.Read => "✓✓ 👁",
        MessageStatus.Failed => "!",
        _ => ""
    };

    private static string StatusTooltip(MessageStatus st) => st switch
    {
        MessageStatus.Pending => "Sending…",
        MessageStatus.Sent => "Sent",
        MessageStatus.Delivered => "Delivered",
        MessageStatus.Read => "Read",
        MessageStatus.Failed => "Failed",
        _ => ""
    };

    private static string FormatTime(DateTime utc)
    {
        var dt = utc.ToLocalTime();
        var today = DateTime.Now.Date;
        if (dt.Date == today) return dt.ToShortTimeString();
        if (dt.Date == today.AddDays(-1)) return "Yesterday";
        return dt.ToString("dd MMM");
    }

    private string GetAvatarText()
    {
        // Private → أول حرف من اسم الشخص
        if (Room.Type == "Private" && !string.IsNullOrWhiteSpace(Room.OtherDisplayName))
            return Room.OtherDisplayName.Substring(0, 1).ToUpper();

        // Group/Other fallback
        return Room.Name.Substring(0, 1).ToUpper();
    }

    private static string Truncate(string? text, int max)
    {
        if (string.IsNullOrWhiteSpace(text)) return string.Empty;
        text = text.Trim();
        if (text.Length <= max) return text;
        return text.Substring(0, max - 1) + "…";
    }
}
