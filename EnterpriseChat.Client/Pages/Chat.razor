@page "/chat/{RoomId:guid}"

@using EnterpriseChat.Client.Models
@inject ApiClient Api
@inject ChatHubClient Hub

<TopBar Room="@room" MembersCount="@onlineUsers.Count" />

@if (room?.Type != "Private")
{
    <PresenceBar OnlineUsers="@onlineUsers" />
}



<MessageList Messages="@messages"
             CurrentUserId="@currentUserId" />

<TypingIndicator TypingUsers="@typingUsers" />

<ChatInput OnSend="Send"
           OnUserTyping="NotifyTyping" />

@code {
    [Parameter] public Guid RoomId { get; set; }

    private List<MessageModel> messages = new();
    private List<UserModel> typingUsers = new();
    private int onlineCount;
    private List<UserModel> onlineUsers = new();
    private RoomModel? room;
    // مؤقتًا لحد ما نربطه بالـ Auth الحقيقي
    private Guid currentUserId = Guid.Parse("11111111-1111-1111-1111-111111111111");

    protected override async Task OnInitializedAsync()
    {
        room = await Api.GetRoomAsync(RoomId);
        // Load history
        messages = (await Api.GetMessagesAsync(RoomId)).ToList();

        // =====================
        // SignalR events
        // =====================

        Hub.MessageReceived += OnMessageReceived;

        Hub.RoomPresenceUpdated += async (roomId, count) =>
{
    if (roomId != RoomId)
        return;

    var users = await Api.GetOnlineUsersInRoomAsync(RoomId);

    onlineUsers = users
        .Select(u => new UserModel
        {
            Id = u.Id,
            DisplayName = u.DisplayName,
            IsOnline = true
        })
        .ToList();

    onlineCount = onlineUsers.Count;
    await InvokeAsync(StateHasChanged);
};

        Hub.TypingStarted += (roomId, userId) =>
        {
            if (roomId != RoomId)
                return;

            if (typingUsers.Any(u => u.Id == userId))
                return;

            var user = onlineUsers.FirstOrDefault(u => u.Id == userId);

            if (user != null)
            {
                typingUsers.Add(user);
                InvokeAsync(StateHasChanged);
            }
        };


        Hub.TypingStopped += (roomId, userId) =>
 {
     typingUsers.RemoveAll(u => u.Id == userId);
     InvokeAsync(StateHasChanged);
 };


        await Hub.ConnectAsync();
        await Hub.JoinRoomAsync(RoomId);
    }

    private void OnMessageReceived(MessageModel message)
    {
        messages.Add(message);
        InvokeAsync(StateHasChanged);
    }

    private Task Send(string text)
    {
        // لسه هنربطه بإرسال الرسالة
        return Task.CompletedTask;
    }

    private Task NotifyTyping()
        => Hub.NotifyTypingAsync(RoomId);
}
